// Generated by CoffeeScript 1.7.1
var PancakeApp,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

$(document).ready(function() {
  var pancakeApp;
  pancakeApp = new PancakeApp();
  $(document).on("touchmove", function(evt) {
    return evt.preventDefault();
  });
  $(document).on("touchmove", ".scrollable", function(evt) {
    return evt.stopPropagation();
  });
  pancakeApp.go();
});

PancakeApp = (function() {
  function PancakeApp() {
    this.sendChunkToBot = __bind(this.sendChunkToBot, this);
    this.panSize = {
      width: 400,
      height: 319
    };
    $("body").prepend("<div id=\"sqWrapper\">\n	<div class=\"app\">\n		<h1 style=\"color:blue\">Pancake Bot 2D</h1>\n	</div>\n</div>\n<div id=\"debug1\"></div>");
    $(window).on('orientationchange', (function(_this) {
      return function() {
        return _this.redisplay();
      };
    })(this));
    $(window).on('resize', (function(_this) {
      return function() {
        return _this.redisplay();
      };
    })(this));
    return;
  }

  PancakeApp.prototype.calcLayout = function() {
    var buttonsBoxHeight, buttonsBoxWidth, buttonsBoxX, buttonsBoxY, buttonsMarginY, isPortrait, logoBoxHeight, logoBoxWidth, logoBoxX, logoBoxY, logoMarginY, logoOnBottomRight, panMarginX, panMarginY, winHeight, winWidth;
    panMarginX = 20;
    panMarginY = 30;
    winWidth = window.innerWidth;
    winHeight = window.innerHeight;
    isPortrait = winWidth < winHeight;
    if (isPortrait) {
      this.panWidth = winWidth - 2 * panMarginX;
      this.panHeight = this.panWidth * this.panSize.height / this.panSize.width;
      this.panX = panMarginX;
      this.panY = winHeight - this.panHeight - panMarginY;
    } else if (winWidth / winHeight < 1.3) {
      this.panWidth = winWidth * 0.83;
      this.panHeight = this.panWidth * this.panSize.height / this.panSize.width;
      this.panX = panMarginX;
      this.panY = panMarginY;
    } else {
      this.panHeight = winHeight - 2 * panMarginY;
      this.panWidth = this.panHeight * this.panSize.width / this.panSize.height;
      this.panX = panMarginX;
      this.panY = panMarginY;
    }
    this.panBitmapRect = {
      x: this.panX,
      y: this.panY,
      width: this.panWidth,
      height: this.panHeight
    };
    this.pancakeSketchRect = {
      x: this.panX,
      y: this.panY,
      width: this.panHeight,
      height: this.panHeight
    };
    if (!isPortrait) {
      logoMarginY = 150;
      logoBoxX = this.panX + this.panWidth * 0.83;
      logoBoxY = this.panY + logoMarginY;
      logoBoxWidth = 214;
      logoBoxHeight = logoBoxWidth;
    } else {
      logoOnBottomRight = false;
      if (logoOnBottomRight) {
        logoBoxWidth = this.panWidth * 0.2;
        logoBoxHeight = logoBoxWidth;
        logoBoxX = winWidth * 0.8 - 20;
        logoBoxY = this.panY + this.panHeight - logoBoxWidth - 20;
      } else {
        logoBoxWidth = 214;
        logoBoxHeight = logoBoxWidth;
        logoBoxX = panMarginX;
        logoBoxY = panMarginY;
      }
    }
    this.logoRect = {
      x: logoBoxX,
      y: logoBoxY,
      width: logoBoxWidth,
      height: logoBoxHeight
    };
    if (!isPortrait) {
      buttonsMarginY = 450;
      buttonsBoxX = this.panX + this.panWidth * 0.83;
      buttonsBoxY = this.panY + buttonsMarginY;
      buttonsBoxWidth = winWidth - buttonsBoxX;
      buttonsBoxHeight = winHeight - buttonsBoxY;
    } else {
      buttonsBoxX = winWidth * 0.5;
      buttonsBoxY = panMarginY;
      buttonsBoxWidth = 250;
      buttonsBoxHeight = winHeight - this.panY;
    }
    this.buttonsRect = {
      x: buttonsBoxX,
      y: buttonsBoxY,
      width: buttonsBoxWidth,
      height: buttonsBoxHeight
    };
  };

  PancakeApp.prototype.go = function() {
    this.calcLayout();
    this.panDisplay = new PanDisplay("#sqWrapper", this.panBitmapRect, this.pancakeSketchRect, this.buttonsRect, this.logoRect);
    $('#printbtn').on("click", (function(_this) {
      return function() {
        var pancakeData, pancakeDataJson;
        pancakeData = {
          panBounds: _this.panDisplay.getPanBoundary(),
          strokes: _this.panDisplay.getStrokes()
        };
        pancakeDataJson = JSON.stringify(pancakeData);
        _this.sendChunkToBot(pancakeDataJson, true);
      };
    })(this));
  };

  PancakeApp.prototype.redisplay = function() {
    this.calcLayout();
    this.panDisplay.reposition(this.panBitmapRect, this.pancakeSketchRect, this.buttonsRect, this.logoRect);
  };

  PancakeApp.prototype.sendChunkToBot = function(strokeRemainder, firstChunk) {
    var MAX_CONTENT_POST_MSG, urlToUse;
    MAX_CONTENT_POST_MSG = 500;
    if (firstChunk) {
      if (strokeRemainder.length <= MAX_CONTENT_POST_MSG) {
        urlToUse = "printinitgo";
      } else {
        urlToUse = "printinit";
      }
    } else {
      if (strokeRemainder.length > MAX_CONTENT_POST_MSG) {
        urlToUse = "printpart";
      } else {
        urlToUse = "printgo";
      }
    }
    if (strokeRemainder.length === 0) {
      this.postStrokesCompleted();
    } else {
      console.log("Sending " + urlToUse + " " + strokeRemainder.slice(0, MAX_CONTENT_POST_MSG).length);
      $.ajax({
        type: "POST",
        url: urlToUse,
        contentType: 'text/plain',
        data: strokeRemainder.slice(0, MAX_CONTENT_POST_MSG),
        success: (function(_this) {
          return function() {
            var remainder;
            remainder = strokeRemainder.slice(MAX_CONTENT_POST_MSG);
            _this.sendChunkToBot(remainder, false);
          };
        })(this)
      });
    }
  };

  PancakeApp.prototype.postStrokesCompleted = function() {
    console.log("completed POST");
  };

  return PancakeApp;

})();
